<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Caminos Calidad Providencia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- ESTILO GENERAL TEMA VERDE PROVIDENCIA --- */
        :root {
            --prov-green-dark: #1b5e20;
            --prov-green-main: #2e7d32;
            --prov-green-light: #e8f5e9;
            --prov-red-route: #d32f2f;
            --prov-gray-alt: #757575;
            --prov-green-clear: #4caf50;
            --sidebar-width: 380px;
        }

        body { margin: 0; padding: 0; font-family: 'Roboto', 'Segoe UI', Arial, sans-serif; height: 100vh; display: flex; overflow: hidden; color: #333; }
        
        #app-container { display: flex; width: 100%; height: 100%; position: relative; }

        /* --- BOTÓN TOGGLE (MÓVIL) --- */
        #sidebar-toggle {
            position: absolute; top: 15px; left: 15px; z-index: 3000;
            background-color: var(--prov-green-dark); color: white;
            border: none; border-radius: 4px; padding: 10px 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer;
            display: none; transition: background 0.2s;
        }
        
        /* --- SIDEBAR --- */
        #sidebar {
            width: var(--sidebar-width);
            height: 100%;
            background-color: var(--prov-green-light);
            border-right: 1px solid #c8e6c9;
            display: flex; flex-direction: column; z-index: 2000;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            transition: transform 0.3s ease-in-out;
            flex-shrink: 0;
        }

        #sidebar.collapsed { transform: translateX(-100%); position: absolute; }

        .sidebar-header {
            background-color: var(--prov-green-dark);
            color: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between;
        }
        .header-title { display: flex; align-items: center; gap: 10px; }
        .sidebar-header h1 { margin: 0; font-size: 1.1rem; font-weight: 500; }
        
        .close-sidebar-btn { display: none; background: none; border: none; color: white; font-size: 1.2rem; cursor: pointer; }

        .sidebar-content { padding: 20px; overflow-y: auto; flex-grow: 1; }

        /* INPUTS Y FORMULARIOS */
        .form-group { margin-bottom: 15px; position: relative; }
        .form-label {
            display: block; font-size: 0.7rem; text-transform: uppercase;
            letter-spacing: 1px; color: var(--prov-green-main); margin-bottom: 5px; font-weight: 700;
        }
        
        .input-wrapper { position: relative; display: flex; align-items: center; }
        .input-icon { position: absolute; left: 10px; color: var(--prov-green-main); opacity: 0.7; }
        input[type="text"] {
            width: 100%; padding: 10px 10px 10px 35px; box-sizing: border-box;
            border: 1px solid #a5d6a7; border-radius: 4px; font-size: 0.9rem;
            transition: all 0.3s; background: white;
        }
        input[type="text"]:focus { border-color: var(--prov-green-dark); outline: none; }

        /* BOTONES */
        .btn-group { display: flex; gap: 5px; margin-top: 5px; }
        button {
            padding: 8px 12px; border: 1px solid transparent; border-radius: 4px;
            cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.2s; width: 100%;
        }
        
        .btn-primary { background-color: var(--prov-green-main); color: white; margin-top: 15px; padding: 12px; font-size: 1rem; }
        .btn-secondary { background-color: #fff; border: 1px solid var(--prov-green-main); color: var(--prov-green-main); }
        .btn-link { background: none; color: var(--prov-green-main); border: none; text-align: left; padding: 0; margin-top: 5px; font-size: 0.8rem; width: auto;}
        .btn-danger { background-color: #fff; border: 1px solid #e74c3c; color: #e74c3c; margin-top: 20px;}
        
        /* BOTÓN ALTERNATIVA */
        .btn-alt { 
            background-color: #f39c12; color: white; margin-top: 10px; display: none; 
            border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-alt:hover { background-color: #e67e22; }

        /* BOTÓN INSTRUCCIONES */
        .btn-instr {
            background-color: var(--prov-green-dark); color: white; border: none;
            padding: 10px 12px; font-size: 0.8rem; display: none; margin-top: 10px;
        }

        /* RESULTADOS BÚSQUEDA */
        .search-results {
            position: absolute; top: 100%; left: 0; right: 0; background: white;
            border: 1px solid #a5d6a7; border-top: none; z-index: 5000;
            max-height: 200px; overflow-y: auto; display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2); margin: 0; padding: 0; list-style: none;
        }
        .search-results li { padding: 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 0.9rem; }
        .search-results li:hover { background-color: var(--prov-green-light); color: var(--prov-green-dark); }

        /* INFO AREA & INSTRUCCIONES */
        #route-info {
            margin-top: 15px; padding: 15px; background: #c8e6c9;
            border-left: 4px solid var(--prov-green-dark); border-radius: 4px;
            font-size: 0.9rem; color: var(--prov-green-dark); display: none;
        }

        #directions-panel {
            margin-top: 10px; background: white; border: 1px solid #c8e6c9;
            border-radius: 4px; max-height: 300px; overflow-y: auto; display: none;
            font-size: 0.85rem;
        }
        .instruction-step {
            padding: 8px 10px; border-bottom: 1px solid #eee; display: flex; align-items: start; gap: 10px;
        }
        .step-icon { color: var(--prov-green-main); width: 20px; text-align: center; }
        .step-dist { font-weight: bold; color: #757575; font-size: 0.75rem; min-width: 45px; text-align: right; }

        /* STOP OVER */
        #stopover-section { display: none; padding: 10px; background: rgba(255,255,255,0.6); border: 1px dashed var(--prov-green-main); margin-bottom: 15px; border-radius: 4px; }

        /* MAPA */
        #map-wrapper { flex-grow: 1; position: relative; height: 100%; z-index: 1; }
        #map { width: 100%; height: 100%; }
        
        .leaflet-routing-container { display: none !important; }

        /* --- RESPONSIVE MOBILE --- */
        @media (max-width: 768px) {
            #sidebar-toggle { display: block; }
            #sidebar {
                position: absolute; top: 0; left: 0; height: 100%; width: 90%;
                transform: translateX(-100%);
            }
            #sidebar.active { transform: translateX(0); }
            .close-sidebar-btn { display: block; }
        }
    </style>
</head>
<body>

    <div id="app-container">
        
        <button id="sidebar-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

        <aside id="sidebar">
            <div class="sidebar-header">
                <div class="header-title"><i class="fas fa-tractor"></i><h1>Caminos Calidad</h1></div>
                <button class="close-sidebar-btn" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
            </div>

            <div class="sidebar-content">
                <div class="form-group">
                    <label class="form-label">Punto de Origen</label>
                    <div class="input-wrapper">
                        <i class="fas fa-map-marker-alt input-icon"></i>
                        <input type="text" id="input-origen" placeholder="Buscar hacienda..." onkeyup="buscar('origen')" autocomplete="off">
                    </div>
                    <ul id="list-origen" class="search-results"></ul>
                    <div class="btn-group">
                        <button class="btn-secondary" onclick="usarGPS()"><i class="fas fa-crosshairs"></i> GPS</button>
                        <button class="btn-secondary" onclick="activarManual('origen')"><i class="fas fa-hand-pointer"></i> Mapa</button>
                    </div>
                </div>

                <button id="btn-add-stop" class="btn-link" onclick="toggleParada(true)">
                    <i class="fas fa-plus-circle"></i> Agregar parada intermedia
                </button>
                <div id="stopover-section">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <label class="form-label" style="margin:0;">Parada Intermedia</label>
                        <button class="btn-link" style="color:#e74c3c; width:auto;" onclick="toggleParada(false)"><i class="fas fa-times"></i> Quitar</button>
                    </div>
                    <div class="form-group" style="margin-bottom:0;">
                        <div class="input-wrapper">
                            <i class="fas fa-map-marker-alt input-icon"></i>
                            <input type="text" id="input-inter" placeholder="Buscar parada..." onkeyup="buscar('inter')" autocomplete="off">
                        </div>
                        <ul id="list-inter" class="search-results"></ul>
                    </div>
                    <button class="btn-secondary" style="margin-top:5px;" onclick="activarManual('inter')"><i class="fas fa-hand-pointer"></i> Seleccionar en mapa</button>
                </div>

                <div style="margin-bottom: 20px;"></div>

                <div class="form-group">
                    <label class="form-label">Destino Final</label>
                    <div class="input-wrapper">
                        <i class="fas fa-flag-checkered input-icon"></i>
                        <input type="text" id="input-dest" placeholder="Buscar hacienda..." onkeyup="buscar('dest')" autocomplete="off">
                    </div>
                    <ul id="list-dest" class="search-results"></ul>
                    <button class="btn-secondary" style="margin-top:5px;" onclick="activarManual('dest')"><i class="fas fa-hand-pointer"></i> Seleccionar en mapa</button>
                </div>

                <button class="btn-primary" onclick="calcularRuta()"><i class="fas fa-route"></i> TRAZAR RUTA</button>

                <button id="btn-alt" class="btn-alt" onclick="cambiarRutaAlternativa()">
                    <i class="fas fa-exchange-alt"></i> Cambiar Ruta
                </button>

                <div id="route-info"></div>
                
                <button id="btn-instr" class="btn-instr" onclick="toggleInstrucciones()">
                    <i class="fas fa-list-ol"></i> Ver Instrucciones
                </button>

                <div id="directions-panel"></div>
                
                <button class="btn-danger" onclick="limpiarTodo()"><i class="fas fa-eraser"></i> Nueva Consulta</button>
            </div>
            
            <div style="padding: 10px; text-align: center; font-size: 0.7rem; color: var(--prov-green-main); border-top: 1px solid #c8e6c9;">
                Ingenio Providencia &copy; 2025
            </div>
        </aside>

        <main id="map-wrapper">
            <div id="map"></div>
        </main>
    </div>

    <script>
        // --- 1. CONFIGURACIÓN MAPA (Satélite por defecto) ---
        var map = L.map('map', { 
            zoomControl: false,
            maxBounds: [[3.0, -77.0], [4.5, -75.5]], 
            maxBoundsViscosity: 0.5 
        }).setView([3.62, -76.30], 12);
        
        L.control.zoom({ position: 'topright' }).addTo(map);

        var calles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' });
        var satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '' });
        
        // --- INICIAMOS EN SATELITAL ---
        satelite.addTo(map);

        L.control.layers({ "Mapa": calles, "Satelital": satelite }, null, { position: 'topright' }).addTo(map);

        // --- 2. VARIABLES GLOBALES ---
        var dbHaciendas = [];
        var puntos = { origen: null, inter: null, dest: null };
        var markers = { origen: null, inter: null, dest: null };
        var controlRuta = null;
        var rutasEncontradas = []; 
        var rutaIndex = 0;         
        var modoManual = null;
        var highlightLayer = null; 

        const redIconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png';
        // Estilo de polígono de hacienda (Verde Clarito)
        const GREEN_POLYGON_STYLE = { color: '#4caf50', weight: 1, opacity: 0.8, fillColor: '#81c784', fillOpacity: 0.4 }; 

        // --- 3. CARGA DE DATOS ---
        fetch('haciendas.geojson')
            .then(res => { if(!res.ok) throw new Error("Fallo"); return res.json(); })
            .then(data => {
                dbHaciendas = data.features;
                L.geoJSON(data, {
                    style: GREEN_POLYGON_STYLE, 
                    onEachFeature: (f, layer) => {
                        var n = getNombre(f);
                        layer.bindTooltip(n, {direction: 'top', sticky: true});
                        layer.on('click', () => {
                            var centro = layer.getBounds().getCenter();
                            setPunto('dest', centro, n);
                        });
                    }
                }).addTo(map);
            })
            .catch(err => console.log("Advertencia: Sin datos geojson"));

        function getNombre(f) { return f.properties.Nombre || f.properties.name || f.properties.NOMBRE || f.properties.Hacienda || "Ubicación"; }

        // --- 4. BÚSQUEDA INTELIGENTE y 5. GESTIÓN PUNTOS (código auxiliar) ---
        function buscar(tipo) {
            var inputId = 'input-' + tipo; var listId = 'list-' + tipo;
            var txt = document.getElementById(inputId).value.toLowerCase();
            var lista = document.getElementById(listId);
            lista.innerHTML = ""; lista.style.display = "none";

            if (txt.length < 2) return;

            var resultados = dbHaciendas.filter(h => getNombre(h).toLowerCase().includes(txt));
            
            resultados.slice(0, 8).forEach(h => {
                var li = document.createElement("li");
                var nombre = getNombre(h);
                li.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${nombre}`;
                
                li.onclick = function() {
                    try {
                        var tempLayer = L.geoJSON(h);
                        var centro = tempLayer.getBounds().getCenter();
                        setPunto(tipo, centro, nombre);
                        lista.style.display = "none";
                    } catch (e) { console.error(e); }
                };
                lista.appendChild(li);
            });
            if (resultados.length > 0) lista.style.display = "block";
        }

        function setPunto(tipo, latlng, nombre) {
            puntos[tipo] = latlng;
            document.getElementById('input-' + tipo).value = nombre;
            if (markers[tipo]) map.removeLayer(markers[tipo]);
            markers[tipo] = L.marker(latlng, {
                icon: L.icon({
                    iconUrl: redIconUrl,
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                })
            }).addTo(map).bindPopup(nombre).openPopup();
            map.setView(latlng, 14);
            if (modoManual) { document.getElementById('map').style.cursor = ''; modoManual = null; }
            if (window.innerWidth <= 768) toggleSidebar();
        }

        function activarManual(tipo) {
            modoManual = tipo; 
            document.getElementById('map').style.cursor = 'crosshair';
            if (window.innerWidth <= 768) toggleSidebar();
        }
        map.on('click', function(e) { if (modoManual) setPunto(modoManual, e.latlng, "Selección Manual"); });

        function usarGPS() {
            if (!navigator.geolocation) return alert("GPS no disponible");
            navigator.geolocation.getCurrentPosition(
                (pos) => setPunto('origen', L.latLng(pos.coords.latitude, pos.coords.longitude), "Mi Ubicación"),
                () => alert("Error GPS")
            );
        }

        function toggleParada(mostrar) {
            document.getElementById('stopover-section').style.display = mostrar ? 'block' : 'none';
            document.getElementById('btn-add-stop').style.display = mostrar ? 'none' : 'block';
            if (!mostrar) { 
                puntos.inter = null; 
                if(markers.inter) { map.removeLayer(markers.inter); markers.inter = null; }
                document.getElementById('input-inter').value = ""; 
            }
        }
        
        // --- 6. CÁLCULO DE RUTA (CON AJUSTE DE MAPA) ---
        function calcularRuta() {
            if (!puntos.origen || !puntos.dest) return alert("Falta Origen o Destino");

            var waypoints = [puntos.origen];
            if (puntos.inter) waypoints.push(puntos.inter);
            waypoints.push(puntos.dest);

            if (controlRuta) map.removeControl(controlRuta);
            if (highlightLayer) map.removeLayer(highlightLayer); 

            // Reset UI
            document.getElementById('route-info').style.display = 'block';
            document.getElementById('route-info').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculando...';
            document.getElementById('btn-alt').style.display = 'none';
            document.getElementById('btn-instr').style.display = 'none';
            document.getElementById('directions-panel').style.display = 'none';

            if(window.innerWidth <= 768) toggleSidebar();
         

            controlRuta = L.Routing.control({
                waypoints: waypoints,
                language: 'es', // Idioma de la interfaz (controles)
                router: L.Routing.osrmv1({ 
                    serviceUrl: 'https://router.project-osrm.org/route/v1', 
                    profile: 'driving',
                    language: 'es' // <<--- ESTO FUERZA LAS INSTRUCCIONES EN ESPAÑOL
                }),
                showAlternatives: true, 
                
                lineOptions: { 
                    styles: [{color: '#d32f2f', opacity: 0.9, weight: 7}],
                    addWaypoints: false 
                },
                
                altLineOptions: { 
                    styles: [{color: '#1565c0', opacity: 0.7, weight: 6, dashArray: '10, 10'}] 
                },
                
                createMarker: () => null
            }).addTo(map);

            controlRuta.on('routesfound', function(e) {
                rutasEncontradas = e.routes;
                rutaIndex = 0; 
                
                mostrarDatosRuta(rutasEncontradas[0]);

                // *** FIX: AJUSTAR MAPA A LA RUTA PRINCIPAL ***
                if (e.routes.length > 0) {
                    var bounds = L.latLngBounds(e.routes[0].coordinates);
                    map.fitBounds(bounds, { padding: [20, 20] });
                }
                // **********************************************

                document.getElementById('btn-instr').style.display = 'block';

                var btnAlt = document.getElementById('btn-alt');
                if (rutasEncontradas.length > 1) {
                    btnAlt.style.display = 'block';
                    btnAlt.innerHTML = `<i class="fas fa-exchange-alt"></i> Cambiar Ruta (${rutasEncontradas.length} opciones)`;
                    btnAlt.style.backgroundColor = '#f39c12';
                    btnAlt.onclick = cambiarRutaAlternativa; 
                } else {
                    btnAlt.style.display = 'block';
                    btnAlt.innerHTML = `<i class="fas fa-exclamation-circle"></i> Ruta Única Disponible`;
                    btnAlt.style.backgroundColor = '#95a5a6';
                    btnAlt.onclick = null;
                }
            });
            
            controlRuta.on('routingerror', function() {
                document.getElementById('route-info').innerHTML = "❌ No se encontró camino.";
            });
        }

        // --- 7. CAMBIO DE RUTA PROGRAMADO (CON AJUSTE DE MAPA) ---
        function cambiarRutaAlternativa() {
            if (!rutasEncontradas || rutasEncontradas.length < 2) return;

            rutaIndex = (rutaIndex + 1) % rutasEncontradas.length;
            var rutaSeleccionada = rutasEncontradas[rutaIndex];

            mostrarDatosRuta(rutaSeleccionada);
            
            // *** FIX: AJUSTAR MAPA A LA RUTA ALTERNATIVA SELECCIONADA ***
            var bounds = L.latLngBounds(rutaSeleccionada.coordinates);
            map.fitBounds(bounds, { padding: [20, 20] });
            // *************************************************************

            if (highlightLayer) map.removeLayer(highlightLayer);
            
            if (rutaIndex !== 0) {
                highlightLayer = L.polyline(rutaSeleccionada.coordinates, {
                    color: '#2ecc71', 
                    weight: 8,
                    opacity: 0.9
                }).addTo(map);
            }
            
            var btnAlt = document.getElementById('btn-alt');
            
            if (rutaIndex === 0) {
                 btnAlt.innerHTML = `<i class="fas fa-exchange-alt"></i> Viendo Ruta Principal`;
            } else if (rutasEncontradas.length === 2 && rutaIndex === 1) {
                btnAlt.innerHTML = `<i class="fas fa-exchange-alt"></i> Volver a Ruta Principal`;
            } else {
                btnAlt.innerHTML = `<i class="fas fa-exchange-alt"></i> Viendo Opción ${rutaIndex + 1} de ${rutasEncontradas.length}`;
            }
        }

        // --- 8. MOSTRAR DATOS E INSTRUCCIONES ---
        function mostrarDatosRuta(ruta) {
            var km = (ruta.summary.totalDistance / 1000).toFixed(1);
            var min = Math.round(ruta.summary.totalTime / 60);
            
            document.getElementById('route-info').innerHTML = `
                <div style="text-align:center">
                    <strong><i class="fas fa-check-circle"></i> Opción ${rutaIndex + 1}</strong><br>
                    <span style="font-size:1.4rem; font-weight:bold">${km} km</span> &nbsp;|&nbsp; 
                    <span style="font-size:1.4rem; font-weight:bold">${min} min</span>
                </div>
            `;

            var panel = document.getElementById('directions-panel');
            panel.innerHTML = ""; 
            ruta.instructions.forEach(step => {
                var iconClass = getIconoInstruccion(step.type, step.modifier);
                var dist = step.distance > 1000 ? (step.distance/1000).toFixed(1) + ' km' : Math.round(step.distance) + ' m';
                if(step.distance === 0) dist = "";

                var div = document.createElement('div');
                div.className = 'instruction-step';
                div.innerHTML = `<div class="step-icon"><i class="${iconClass}"></i></div><div style="flex-grow:1">${step.text}</div><div class="step-dist">${dist}</div>`;
                panel.appendChild(div);
            });
        }

        function getIconoInstruccion(type, mod) {
            if(type === 'Head') return 'fas fa-car';
            if(type === 'DestinationReached') return 'fas fa-flag-checkered';
            if(type === 'Roundabout') return 'fas fa-sync';
            if(mod && mod.includes('Left')) return 'fas fa-arrow-left';
            if(mod && mod.includes('Right')) return 'fas fa-arrow-right';
            return 'fas fa-arrow-up';
        }
        
        function toggleInstrucciones() {
            var panel = document.getElementById('directions-panel');
            var btn = document.getElementById('btn-instr');
            if (panel.style.display === 'none' || panel.style.display === '') {
                panel.style.display = 'block';
                btn.innerHTML = '<i class="fas fa-times"></i> Ocultar Instrucciones';
            } else {
                panel.style.display = 'none';
                btn.innerHTML = '<i class="fas fa-list-ol"></i> Ver Instrucciones';
            }
        }

        // --- 9. UI UTILS ---
        function toggleSidebar() {
            var sb = document.getElementById('sidebar');
            if(window.innerWidth <= 768) sb.classList.toggle('active');
            else sb.classList.toggle('collapsed');
        }

        function limpiarTodo() { 
            // La recarga es el método más seguro para un reseteo completo
            location.reload(); 
        }
    </script>
</body>
</html>