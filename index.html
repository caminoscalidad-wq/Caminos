<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Caminos Calidad Providencia - Sistema de Optimización de Rutas Rurales</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Sistema SIG de planificación de rutas optimizadas para transporte agrícola del Ingenio Providencia">
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    
    <!-- Leaflet Fullscreen -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@2.4.0/Control.FullScreen.css" />
    <script src="https://unpkg.com/leaflet.fullscreen@2.4.0/Control.FullScreen.js"></script>
    
    <!-- Font Awesome & Material Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Roboto Font -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- VARIABLES CSS TEMA PROVIDENCIA --- */
        :root {
            --prov-green-dark: #1b5e20;
            --prov-green-main: #2e7d32;
            --prov-green-light: #e8f5e9;
            --prov-green-lighter: #f1f8e9;
            --prov-red-route: #d32f2f;
            --prov-blue-alt: #1976d2;
            --prov-yellow-alt: #fbc02d;
            --prov-orange-warning: #f57c00;
            --prov-gray-light: #f5f5f5;
            --prov-gray-medium: #757575;
            --prov-gray-dark: #424242;
            --shadow-light: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-medium: 0 4px 12px rgba(0,0,0,0.15);
            --shadow-heavy: 0 6px 20px rgba(0,0,0,0.2);
            --sidebar-width: 420px;
            --mobile-sidebar-height: 85vh;
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- RESET Y ESTILO GENERAL --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
            color: var(--prov-gray-dark);
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            touch-action: pan-x pan-y;
        }

        #app-container {
            display: flex;
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        
        /* --- BOTÓN TOGGLE MEJORADO (MÓVIL) --- */
        #sidebar-toggle {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 3000;
            background: linear-gradient(135deg, var(--prov-green-main), var(--prov-green-dark));
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            box-shadow: var(--shadow-heavy);
            cursor: pointer;
            display: none;
            transition: var(--transition);
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        #sidebar-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        /* --- SIDEBAR REDISEÑADO --- */
        #sidebar {
            width: var(--sidebar-width);
            height: 100%;
            background: white;
            border-right: 1px solid rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            z-index: 2000;
            box-shadow: var(--shadow-medium);
            transition: var(--transition);
            flex-shrink: 0;
        }

        #sidebar.collapsed {
            transform: translateX(-100%);
            box-shadow: none;
        }

        .sidebar-header {
            background: linear-gradient(135deg, var(--prov-green-dark), var(--prov-green-main));
            color: white;
            padding: 25px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }

        .sidebar-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-icon {
            font-size: 1.8rem;
            background: rgba(255,255,255,0.2);
            padding: 12px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sidebar-header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .sidebar-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 4px;
            font-weight: 300;
        }

        .close-sidebar-btn {
            display: none;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        .close-sidebar-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .sidebar-content {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
            background: var(--prov-gray-light);
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: var(--prov-green-main) transparent;
        }

        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background-color: var(--prov-green-main);
            border-radius: 3px;
        }

        /* --- TARJETAS DE SECCIÓN --- */
        .section-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 22px;
            margin-bottom: 22px;
            box-shadow: var(--shadow-light);
            border-left: 5px solid var(--prov-green-main);
            transition: var(--transition);
        }

        .section-card:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 18px;
            color: var(--prov-green-dark);
            font-size: 1.1rem;
        }

        .section-title i {
            color: var(--prov-green-main);
            font-size: 1.2rem;
        }

        /* --- INPUTS MEJORADOS --- */
        .form-group {
            margin-bottom: 22px;
            position: relative;
        }

        .form-label {
            display: block;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--prov-gray-medium);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-icon {
            position: absolute;
            left: 15px;
            color: var(--prov-green-main);
            opacity: 0.9;
            z-index: 2;
            font-size: 1.1rem;
        }

        input[type="text"] {
            width: 100%;
            padding: 16px 16px 16px 50px;
            box-sizing: border-box;
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: white;
            font-family: 'Roboto', sans-serif;
            -webkit-appearance: none;
        }

        input[type="text"]:focus {
            border-color: var(--prov-green-main);
            outline: none;
            box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.1);
        }

        /* --- LISTA DE RESULTADOS DE BÚSQUEDA --- */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--prov-green-light);
            border-top: none;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            max-height: 250px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: var(--shadow-medium);
        }

        .search-results li {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: var(--transition);
            -webkit-tap-highlight-color: transparent; /* Elimina el azul en tap móvil */
        }

        .search-results li:hover {
            background: var(--prov-green-light);
        }

        .search-results li:last-child {
            border-bottom: none;
        }

        .search-results li i {
            color: var(--prov-green-main);
            width: 16px;
        }

        /* --- BOTONES MEJORADOS --- */
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 15px;
        }

        button {
            padding: 14px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-family: 'Roboto', sans-serif;
            touch-action: manipulation;
            min-height: 52px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--prov-green-main), var(--prov-green-dark));
            color: white;
            margin-top: 25px;
            padding: 18px;
            font-size: 1.1rem;
            font-weight: 600;
            box-shadow: var(--shadow-medium);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-heavy);
            background: linear-gradient(135deg, var(--prov-green-dark), var(--prov-green-main));
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: white;
            border: 2px solid var(--prov-green-main);
            color: var(--prov-green-main);
            flex: 1;
        }

        .btn-secondary:hover {
            background: var(--prov-green-light);
            border-color: var(--prov-green-dark);
        }

        .btn-link {
            background: none;
            color: var(--prov-green-main);
            border: none;
            text-align: left;
            padding: 0;
            margin-top: 8px;
            font-size: 0.9rem;
            width: auto;
            justify-content: flex-start;
            text-transform: none;
            min-height: auto;
        }

        .btn-link:hover {
            color: var(--prov-green-dark);
            text-decoration: underline;
        }

        .btn-danger {
            background: white;
            border: 2px solid #e74c3c;
            color: #e74c3c;
            margin-top: 25px;
        }

        .btn-danger:hover {
            background: #ffeaea;
            border-color: #c0392b;
        }

        .btn-alt {
            background: linear-gradient(135deg, var(--prov-blue-alt), #1565c0);
            color: white;
            margin-top: 15px;
            display: none;
            box-shadow: var(--shadow-medium);
        }

        .btn-alt:hover {
            background: linear-gradient(135deg, #1565c0, var(--prov-blue-alt));
            transform: translateY(-2px);
        }

        .btn-gps {
            background: linear-gradient(135deg, var(--prov-blue-alt), #1565c0);
            color: white;
        }

        .btn-gps:hover {
            background: linear-gradient(135deg, #1565c0, var(--prov-blue-alt));
        }

        /* --- PANEL DE INSTRUCCIONES FLOTANTE MEJORADO --- */
        #floating-directions {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 380px;
            max-height: 80vh;
            background: white;
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 1500;
            display: none;
            overflow: hidden;
            flex-direction: column;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.97);
        }

        #drag-handle {
            padding: 18px 20px;
            background: linear-gradient(135deg, var(--prov-green-main), var(--prov-green-dark));
            color: white;
            cursor: move;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            user-select: none;
            font-size: 1rem;
        }

        #drag-handle:active {
            cursor: grabbing;
        }

        #close-float-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            font-size: 1.1rem;
        }

        #close-float-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        #directions-content {
            overflow-y: auto;
            flex-grow: 1;
            padding: 0;
            -webkit-overflow-scrolling: touch;
        }

        .route-summary {
            padding: 20px;
            background: var(--prov-green-lighter);
            border-bottom: 2px solid #e0e0e0;
            text-align: center;
        }

        .route-summary h3 {
            color: var(--prov-green-dark);
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .route-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--prov-green-dark);
            display: block;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--prov-gray-medium);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }

        .instruction-step {
            padding: 18px 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 18px;
            transition: var(--transition);
        }

        .instruction-step.active {
            background: var(--prov-green-light);
            border-left: 4px solid var(--prov-green-main);
        }

        .instruction-step:hover {
            background: var(--prov-green-lighter);
        }

        .instruction-step:last-child {
            border-bottom: none;
        }

        .step-icon {
            background: var(--prov-green-light);
            color: var(--prov-green-main);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.1rem;
        }

        .step-content {
            flex-grow: 1;
            min-width: 0;
        }

        .step-text {
            font-size: 1rem;
            line-height: 1.5;
            color: var(--prov-gray-dark);
            margin-bottom: 5px;
        }

        .step-dist {
            font-weight: 700;
            color: var(--prov-green-dark);
            font-size: 0.95rem;
            min-width: 70px;
            text-align: right;
            flex-shrink: 0;
            background: var(--prov-green-lighter);
            padding: 6px 10px;
            border-radius: 20px;
        }

        /* --- INDICADORES DE PROGRESO --- */
        .route-progress {
            padding: 20px;
            background: white;
            border-top: 2px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--prov-green-main), var(--prov-green-dark));
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .progress-text {
            font-size: 0.9rem;
            color: var(--prov-gray-medium);
            display: flex;
            justify-content: space-between;
            font-weight: 500;
        }

        /* --- CONTROLES PERSONALIZADOS DEL MAPA --- */
        .custom-controls-container {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .custom-control-btn {
            background: white;
            border: none;
            border-radius: var(--border-radius);
            width: 46px;
            height: 46px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-medium);
            cursor: pointer;
            transition: var(--transition);
            color: var(--prov-gray-dark);
            font-size: 1.2rem;
        }

        .custom-control-btn:hover {
            background: var(--prov-green-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-heavy);
            color: var(--prov-green-dark);
        }

        .custom-control-btn.active {
            background: var(--prov-green-main);
            color: white;
            transform: scale(1.05);
        }

        .layer-controls {
            position: absolute;
            bottom: 15px;
            right: 15px;
            z-index: 1000;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-heavy);
            padding: 20px;
            width: 280px;
            display: none;
            flex-direction: column;
            gap: 15px;
        }

        .layer-controls h4 {
            margin: 0 0 15px 0;
            color: var(--prov-green-dark);
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .layer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .layer-item:last-child {
            border-bottom: none;
        }

        .layer-item label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-size: 1rem;
            color: var(--prov-gray-dark);
            flex: 1;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--prov-green-main);
        }

        input:checked + .slider:before {
            transform: translateX(24px);
        }

        /* --- MAPA Y CONTROLES --- */
        #map-wrapper {
            flex-grow: 1;
            position: relative;
            height: 100%;
            z-index: 1;
            background: #f0f0f0;
        }

        #map {
            width: 100%;
            height: 100%;
            transition: all 0.3s ease;
        }

        .leaflet-routing-container {
            display: none !important;
        }

        /* --- CONTROL DE CAPAS PERSONALIZADO --- */
        .leaflet-control-layers {
            border-radius: var(--border-radius) !important;
            overflow: hidden;
            box-shadow: var(--shadow-medium) !important;
        }

        .leaflet-control-zoom {
            border-radius: var(--border-radius) !important;
            overflow: hidden;
            box-shadow: var(--shadow-medium) !important;
        }

        .leaflet-control-fullscreen {
            border-radius: var(--border-radius) !important;
            overflow: hidden;
            box-shadow: var(--shadow-medium) !important;
        }

        /* --- COMPASS CONTROL --- */
        .leaflet-control-compass {
            border-radius: var(--border-radius) !important;
            overflow: hidden;
            box-shadow: var(--shadow-medium) !important;
        }

        /* --- NOTIFICACIONES TOAST --- */
        .toast {
            position: fixed;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--prov-green-dark);
            color: white;
            padding: 18px 28px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 4000;
            display: none;
            align-items: center;
            gap: 15px;
            animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: 90%;
            font-size: 0.95rem;
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }

        /* --- ESTADO GPS --- */
        #gps-status {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-medium);
        }

        /* --- PANEL DE INSTRUCCIONES PARA MÓVIL --- */
        #mobile-instructions {
            display: none;
        }

        .mobile-instructions-container {
            background: white;
            border-radius: var(--border-radius);
            margin-top: 25px;
            overflow: hidden;
            box-shadow: var(--shadow-light);
        }

        /* --- GPS INFO PANEL --- */
        #gps-info {
            position: absolute;
            bottom: 80px;
            left: 15px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--shadow-heavy);
            z-index: 1000;
            max-width: 280px;
            display: none;
            flex-direction: column;
            gap: 10px;
            backdrop-filter: blur(5px);
        }

        /* --- MARCADORES PERSONALIZADOS --- */
        .custom-marker {
            background: white;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 12px rgba(0,0,0,0.3);
            border: 3px solid;
            font-size: 1.1rem;
        }

        .marker-origin {
            border-color: var(--prov-green-main);
            color: var(--prov-green-main);
        }

        .marker-inter {
            border-color: var(--prov-yellow-alt);
            color: var(--prov-yellow-alt);
        }

        .marker-dest {
            border-color: var(--prov-red-route);
            color: var(--prov-red-route);
        }

        /* --- GPS TRACK LINE --- */
        .gps-track {
            stroke: #2196F3;
            stroke-width: 4;
            stroke-opacity: 0.7;
            fill: none;
        }

        /* --- RESPONSIVE MOBILE - MEJORADO --- */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 100%;
                --mobile-sidebar-height: 85vh;
            }

            body {
                background: white;
                overflow: hidden;
            }

            #sidebar-toggle {
                display: flex;
                bottom: 25px;
                right: 25px;
                z-index: 3000;
                width: 64px;
                height: 64px;
                font-size: 1.4rem;
            }

            #sidebar {
                position: fixed;
                top: auto;
                bottom: 0;
                left: 0;
                width: 100%;
                height: var(--mobile-sidebar-height);
                max-height: 100%;
                transform: translateY(100%);
                box-shadow: 0 -10px 40px rgba(0,0,0,0.25);
                border-right: none;
                border-top: 1px solid rgba(0,0,0,0.08);
                border-radius: 25px 25px 0 0;
                overflow: hidden;
                transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            }

            #sidebar.active {
                transform: translateY(0);
            }

            .sidebar-header {
                border-radius: 25px 25px 0 0;
                padding: 30px 25px 25px;
            }

            .close-sidebar-btn {
                display: flex;
            }

            #sidebar.active ~ #sidebar-toggle {
                display: none;
            }

            .section-card {
                padding: 20px;
                margin-bottom: 20px;
            }

            input[type="text"] {
                padding: 18px 18px 18px 55px;
                font-size: 16px;
            }

            button {
                padding: 16px;
                min-height: 56px;
            }

            /* Responsive mobile - sin fixed o transform para evitar problemas en móvil */
            .search-results {
                position: absolute; /* Mantiene absolute relativo al input */
                max-height: 50vh;
                border-radius: 0;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            }

            .custom-controls-container {
                top: 10px;
                left: 10px;
                gap: 8px;
            }

            .custom-control-btn {
                width: 44px;
                height: 44px;
                font-size: 1.1rem;
            }

            #gps-status {
                bottom: 90px;
                font-size: 0.85rem;
                padding: 10px 18px;
                white-space: nowrap;
                max-width: 90%;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            #floating-directions {
                display: none !important;
            }

            #mobile-instructions {
                display: block;
            }

            .btn-instr-sidebar {
                display: block !important;
                margin-top: 20px;
            }

            /* Ajustar mapa cuando sidebar está abierto */
            #sidebar.active ~ #map-wrapper #map {
                height: calc(100% - var(--mobile-sidebar-height));
            }

            .layer-controls {
                width: calc(100% - 30px);
                max-width: 320px;
                bottom: 80px;
                right: 15px;
            }

            #gps-info {
                left: 10px;
                right: 10px;
                max-width: none;
                bottom: 100px;
            }
        }

        /* --- ANIMACIONES DE CARGA --- */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinning {
            animation: spin 1s linear infinite;
        }

        /* --- ROTACIONES PARA ICONOS --- */
        .rotate-45 {
            transform: rotate(45deg);
        }

        .rotate-90 {
            transform: rotate(90deg);
        }

        .rotate-135 {
            transform: rotate(135deg);
        }

        /* --- ESTADO DE LA APP --- */
        .app-state {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: white;
            padding: 10px 20px;
            border-radius: 25px;
            box-shadow: var(--shadow-medium);
            font-size: 0.9rem;
            color: var(--prov-gray-medium);
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(5px);
            background: rgba(255, 255, 255, 0.9);
        }

        /* --- ORIENTATION CONTROLS --- */
        .orientation-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .orientation-btn {
            background: white;
            border: none;
            border-radius: var(--border-radius);
            width: 46px;
            height: 46px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-medium);
            cursor: pointer;
            transition: var(--transition);
            color: var(--prov-gray-dark);
            font-size: 1.2rem;
        }

        .orientation-btn.active {
            background: var(--prov-blue-alt);
            color: white;
        }

        /* --- VOICE CONTROLS --- */
        .voice-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .voice-btn {
            flex: 1;
            padding: 12px;
            font-size: 0.9rem;
            background: linear-gradient(135deg, #673ab7, #512da8);
            color: white;
        }

        .voice-btn.stop {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }

        .voice-btn:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <!-- Estado de la aplicación -->
    <div class="app-state" id="app-state">
        <i class="fas fa-circle" style="color: #4CAF50; font-size: 0.6rem;"></i>
        <span>Sistema de Rutas Rurales - Listo</span>
    </div>

    <!-- Notificaciones Toast -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message">Operación completada</span>
    </div>

    <!-- Estado GPS -->
    <div id="gps-status">
        <i class="fas fa-satellite"></i>
        <span id="gps-status-text">GPS desconectado</span>
    </div>

    <!-- GPS Info Panel -->
    <div id="gps-info"></div>

    <!-- Contenedor principal -->
    <div id="app-container">
        <!-- Botón toggle sidebar (móvil) -->
        <button id="sidebar-toggle" onclick="toggleSidebar()">
            <i class="fas fa-route"></i>
        </button>

        <!-- Panel de instrucciones flotante -->
        <div id="floating-directions">
            <div id="drag-handle">
                <span><i class="fas fa-directions"></i> Instrucciones de Ruta</span>
                <button id="close-float-btn" onclick="toggleInstrucciones(false)">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="route-summary" id="route-summary">
                <!-- Resumen de ruta dinámico -->
            </div>
            <div id="directions-content"></div>
            <div class="route-progress" id="route-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text">
                    <span>Progreso de ruta</span>
                    <span id="progress-percent">0%</span>
                </div>
                <div class="voice-controls">
                    <button class="voice-btn" onclick="speakInstructions()">
                        <i class="fas fa-volume-up"></i> Leer Instrucciones
                    </button>
                    <button class="voice-btn stop" onclick="stopSpeaking()">
                        <i class="fas fa-stop"></i> Detener
                    </button>
                </div>
            </div>
        </div>

        <!-- Sidebar principal -->
        <aside id="sidebar">
            <div class="sidebar-header">
                <div class="header-title">
                    <div class="header-icon">
                        <i class="fas fa-tractor"></i>
                    </div>
                    <div>
                        <h1>Caminos Calidad Providencia</h1>
                        <div class="sidebar-subtitle">Sistema SIG de Optimización de Rutas Rurales</div>
                    </div>
                </div>
                <button class="close-sidebar-btn" onclick="toggleSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="sidebar-content">
                <!-- Sección Origen -->
                <div class="section-card">
                    <div class="section-title">
                        <i class="fas fa-map-marker-alt"></i>
                        <h2>Punto de Origen</h2>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ubicación inicial de transporte</label>
                        <div class="input-wrapper">
                            <i class="fas fa-search input-icon"></i>
                            <input type="text" id="input-origen" placeholder="Buscar hacienda o ubicación..." 
                                   autocomplete="off">
                        </div>
                        <ul id="list-origen" class="search-results"></ul>
                        <div class="btn-group">
                            <button class="btn-gps" onclick="locateMe()">
                                <i class="fas fa-crosshairs"></i> Usar Mi Ubicación
                            </button>
                            <button class="btn-secondary" onclick="activarManual('origen')">
                                <i class="fas fa-hand-pointer"></i> Seleccionar en Mapa
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sección Paradas Intermedias -->
                <div class="section-card" id="stopover-section" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px;">
                        <div class="section-title" style="margin: 0;">
                            <i class="fas fa-map-pin"></i>
                            <h2>Parada Intermedia</h2>
                        </div>
                        <button class="btn-link" style="color: #e74c3c;" onclick="toggleParada(false)">
                            <i class="fas fa-times"></i> Quitar Parada
                        </button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ubicación intermedia (opcional)</label>
                        <div class="input-wrapper">
                            <i class="fas fa-search input-icon"></i>
                            <input type="text" id="input-inter" placeholder="Buscar parada intermedia..." 
                                   autocomplete="off">
                        </div>
                        <ul id="list-inter" class="search-results"></ul>
                        <button class="btn-secondary" onclick="activarManual('inter')">
                            <i class="fas fa-hand-pointer"></i> Seleccionar en Mapa
                        </button>
                    </div>
                </div>

                <!-- Botón para agregar parada -->
                <button id="btn-add-stop" class="btn-link" onclick="toggleParada(true)" 
                        style="margin-bottom: 25px; padding: 12px 0; font-size: 1rem;">
                    <i class="fas fa-plus-circle"></i> Agregar parada intermedia (opcional)
                </button>

                <!-- Sección Destino -->
                <div class="section-card">
                    <div class="section-title">
                        <i class="fas fa-flag-checkered"></i>
                        <h2>Destino Final</h2>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ubicación de destino</label>
                        <div class="input-wrapper">
                            <i class="fas fa-search input-icon"></i>
                            <input type="text" id="input-dest" placeholder="Buscar hacienda de destino..." 
                                   autocomplete="off">
                        </div>
                        <ul id="list-dest" class="search-results"></ul>
                        <button class="btn-secondary" onclick="activarManual('dest')">
                            <i class="fas fa-hand-pointer"></i> Seleccionar en Mapa
                        </button>
                    </div>
                </div>

                <!-- Información de Ruta Calculada -->
                <div class="section-card" id="route-info" style="display: none;">
                    <div class="section-title">
                        <i class="fas fa-chart-line"></i>
                        <h2>Resumen de Ruta Calculada</h2>
                    </div>
                    <div id="route-details">
                        <!-- Detalles de ruta dinámicos -->
                    </div>
                </div>

                <!-- Instrucciones para móvil -->
                <div id="mobile-instructions" style="display: none;">
                    <div class="section-card">
                        <div class="section-title">
                            <i class="fas fa-directions"></i>
                            <h2>Instrucciones de Navegación</h2>
                        </div>
                        <div id="mobile-directions-content"></div>
                        <div class="voice-controls">
                            <button class="voice-btn" onclick="speakInstructions()">
                                <i class="fas fa-volume-up"></i> Leer Instrucciones
                            </button>
                            <button class="voice-btn stop" onclick="stopSpeaking()">
                                <i class="fas fa-stop"></i> Detener Voz
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Botones de acción principales -->
                <button class="btn-primary" onclick="calcularRuta()" id="btn-calcular">
                    <i class="fas fa-route loading" id="route-loading" style="display: none;"></i>
                    <i class="fas fa-route" id="route-icon"></i>
                    <span id="route-text">CALCULAR RUTA ÓPTIMA</span>
                </button>

                <button id="btn-alt" class="btn-alt" onclick="cambiarRutaAlternativa()" style="display: none;">
                    <i class="fas fa-exchange-alt"></i>
                    <span id="alt-text">Cambiar Ruta</span>
                </button>

                <button id="btn-instr" class="btn-primary btn-instr-sidebar" onclick="toggleInstrucciones(true)" 
                        style="display: none; margin-top: 15px;">
                    <i class="fas fa-directions"></i> Ver Instrucciones Detalladas
                </button>

                <button class="btn-danger" onclick="limpiarTodo()">
                    <i class="fas fa-redo"></i> Nueva Consulta
                </button>

                <!-- Información de la app -->
                <div style="padding: 25px 0; text-align: center; font-size: 0.9rem; color: var(--prov-gray-medium);">
                    <div style="margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <i class="fas fa-leaf" style="color: var(--prov-green-main); font-size: 1.2rem;"></i>
                        <span style="font-weight: 500;">Sistema de Optimización de Rutas Rurales</span>
                    </div>
                    <div style="font-size: 0.8rem; opacity: 0.7; line-height: 1.4;">
                        Ingenio Providencia • Departamento Técnico SIG<br>
                        &copy; 2025 • Versión 3.0.0
                    </div>
                </div>
            </div>
        </aside>

        <!-- Mapa principal -->
        <main id="map-wrapper">
            <!-- Controles personalizados -->
            <div class="custom-controls-container">
                <button class="custom-control-btn" id="btn-north" onclick="resetNorth()" title="Reorientar al Norte">
                    <i class="fas fa-compass"></i>
                </button>
                <button class="custom-control-btn" id="btn-layers" onclick="toggleLayerControls()" title="Controles de Capas">
                    <i class="fas fa-layer-group"></i>
                </button>
                <button class="custom-control-btn" id="btn-satellite" onclick="toggleSatellite()" title="Vista Satélite">
                    <i class="fas fa-satellite"></i>
                </button>
                <button class="custom-control-btn" id="btn-gps-track" onclick="toggleGpsTracking()" title="Seguimiento GPS">
                    <i class="fas fa-crosshairs"></i>
                </button>
                <button class="custom-control-btn" id="btn-download" onclick="descargarVia()" title="Descargar Ruta" style="display: none;">
                    <i class="fas fa-download"></i>
                </button>
            </div>

            <!-- Controles de orientación -->
            <div class="orientation-controls">
                <button class="orientation-btn" id="btn-orientation" onclick="toggleDeviceOrientation()" title="Orientar por GPS">
                    <i class="fas fa-location-arrow"></i>
                </button>
            </div>

            <!-- Panel de controles de capas -->
            <div class="layer-controls" id="layer-controls">
                <h4><i class="fas fa-layer-group"></i> Controles de Capas</h4>
                <div class="layer-item">
                    <label>
                        <i class="fas fa-tractor" style="color: var(--prov-green-main);"></i>
                        <span>Haciendas Providencia</span>
                    </label>
                    <label class="switch">
                        <input type="checkbox" id="toggle-haciendas" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="layer-item">
                    <label>
                        <i class="fas fa-satellite" style="color: #388e3c;"></i>
                        <span>Vista Satélite</span>
                    </label>
                    <label class="switch">
                        <input type="checkbox" id="toggle-satelite">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="layer-item" style="border-top: 2px solid #f0f0f0; padding-top: 15px; margin-top: 10px;">
                    <label>
                        <i class="fas fa-download" style="color: var(--prov-blue-alt);"></i>
                        <span>Descargar Ruta</span>
                    </label>
                    <button onclick="descargarVia()" style="
                        background: var(--prov-blue-alt); color: white; border: none;
                        padding: 8px 12px; border-radius: 6px; cursor: pointer;
                        font-size: 0.9rem;">
                        <i class="fas fa-file-download"></i>
                    </button>
                </div>
                <div class="layer-item">
                    <label>
                        <i class="fas fa-trash-alt" style="color: #757575;"></i>
                        <span>Eliminar Ruta</span>
                    </label>
                    <button onclick="eliminarVia()" style="
                        background: #757575; color: white; border: none;
                        padding: 8px 12px; border-radius: 6px; cursor: pointer;
                        font-size: 0.9rem;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <div id="map"></div>
        </main>
    </div>

    <script>
        // ============================================
        // 1. CONFIGURACIÓN INICIAL Y VARIABLES GLOBALES
        // ============================================
        
        // Configuración del mapa
        var map = L.map('map', {
            zoomControl: false,
            maxBounds: [[3.0, -77.0], [4.5, -75.5]],
            maxBoundsViscosity: 0.8,
            preferCanvas: true,
            inertia: true,
            inertiaDeceleration: 3000,
            fadeAnimation: true,
            zoomAnimation: true,
            tap: false
        }).setView([3.62, -76.30], 12);

        // Capas de mapa base
        var calles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap',
            maxZoom: 19,
            minZoom: 10
        });

        var satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: '© Esri',
            maxZoom: 19,
            minZoom: 10
        });

        var topografico = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenTopoMap',
            maxZoom: 17,
            minZoom: 10
        });

        // Añadir capa por defecto
        calles.addTo(map);
        L.control.zoom({ position: 'topright' }).addTo(map);
        L.control.fullscreen({ position: 'topright' }).addTo(map);
        
        // Control de capas base
        var baseLayers = {
            "Mapa Carreteras": calles,
            "Vista Satélite": satelite,
            "Mapa Topográfico": topografico
        };
        
        L.control.layers(baseLayers, null, { position: 'topright' }).addTo(map);

        // Variables globales
        var dbHaciendas = [];
        var puntos = { origen: null, inter: null, dest: null };
        var markers = { origen: null, inter: null, dest: null };
        var controlRuta = null;
        var rutasEncontradas = [];
        var rutaIndex = 0;
        var modoManual = null;
        var highlightLayer = null;
        var routeLayer = null;
        var currentRoute = null;
        var speechSynthesis = window.speechSynthesis;
        var currentSpeech = null;

        // Variables para GPS en tiempo real
        var gpsMarker = null;
        var gpsAccuracyCircle = null;
        var gpsWatchId = null;
        var gpsTracking = false;
        var gpsTrackLine = null;
        var gpsTrackPoints = [];
        var gpsCentered = false;

        // Variables para orientación del mapa
        var mapRotation = 0;
        var deviceOrientationEnabled = false;
        var previousHeading = 0;

        // Variables para capas
        var haciendasLayer = null;

        // Colores personalizados
        const COLORS = {
            origin: '#2e7d32',
            inter: '#fbc02d',
            dest: '#d32f2f',
            route: '#d32f2f',
            altRoute: '#1976d2',
            selectedPolygon: '#ff5722',
            gps: '#2196F3'
        };

        // Íconos personalizados
        function createCustomIcon(type) {
            return L.divIcon({
                className: 'custom-marker ' + 'marker-' + type,
                html: `<i class="fas fa-${type === 'origen' ? 'play' : type === 'inter' ? 'pause' : 'flag'}"></i>`,
                iconSize: [36, 36],
                iconAnchor: [18, 18],
                popupAnchor: [0, -18]
            });
        }

        // ============================================
        // 2. BÚSQUEDA SIMPLIFICADA (VERSIÓN ANTERIOR QUE FUNCIONABA)
        // ============================================
        
        // Inicializar eventos de búsqueda
        function initSearchEvents() {
            var searchInputs = document.querySelectorAll('input[type="text"]');
            
            searchInputs.forEach(input => {
                var tipo = input.id.replace('input-', '');
                var timeout;
                
                input.addEventListener('input', function() {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        buscar(tipo);
                    }, 300);
                });
                
                input.addEventListener('focus', function() {
                    if (this.value.trim().length >= 2) {
                        buscar(tipo);
                    }
                });
            });
            
            // Cerrar resultados al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.input-wrapper') && !e.target.closest('.search-results')) {
                    document.querySelectorAll('.search-results').forEach(list => {
                        list.style.display = 'none';
                    });
                }
            });
        }

        // Función buscar corregida para móvil
        function buscar(tipo) {
            var inputId = 'input-' + tipo;
            var listId = 'list-' + tipo;
            var txt = document.getElementById(inputId).value.trim().toLowerCase();
            var lista = document.getElementById(listId);
            
            lista.innerHTML = "";
            lista.style.display = "none";
            
            if (txt.length < 2) return;
            
            var resultados = dbHaciendas
                .map(h => {
                    var nombre = getNombre(h);
                    var nombreLower = nombre.toLowerCase();
                    var score = 0;
                    
                    if (nombreLower.startsWith(txt)) score += 100;
                    if (nombreLower.includes(' ' + txt + ' ')) score += 50;
                    if (nombreLower.includes(txt)) score += 30;
                    
                    return { hacienda: h, nombre: nombre, score: score };
                })
                .filter(item => item.score > 0)
                .sort((a, b) => b.score - a.score)
                .slice(0, 8)
                .map(item => item.hacienda);
            
            if (resultados.length > 0) {
                resultados.forEach(h => {
                    var li = document.createElement("li");
                    var nombre = getNombre(h);
                    
                    li.innerHTML = `
                        <i class="fas fa-map-marker-alt"></i>
                        <div style="flex: 1;">
                            <strong>${nombre}</strong>
                            ${h.properties.Area ? `<br><small>Área: ${h.properties.Area} ha</small>` : ''}
                        </div>
                    `;
                    
                    li.onclick = function() {
                        try {
                            var tempLayer = L.geoJSON(h);
                            var centro = tempLayer.getBounds().getCenter();
                            setPunto(tipo, centro, nombre);
                            lista.style.display = "none";
                            mostrarToast(`Ubicación establecida: ${nombre}`, 'success');
                            
                            // En móvil, cerrar el teclado virtual
                            if (window.innerWidth <= 768) {
                                document.getElementById(inputId).blur();
                            }
                        } catch (e) {
                            console.error(e);
                            mostrarToast('Error al establecer ubicación', 'error');
                        }
                    };
                    
                    lista.appendChild(li);
                });
                
                lista.style.display = "block";
            } else {
                var li = document.createElement("li");
                li.innerHTML = '<i class="fas fa-search"></i> No se encontraron resultados';
                li.style.color = 'var(--prov-gray-medium)';
                li.style.cursor = 'default';
                lista.appendChild(li);
                lista.style.display = "block";
            }
        }

        // ============================================
        // 3. CORRECCIÓN: "MI UBICACIÓN" COMO ORIGEN
        // ============================================
        
        function locateMe() {
            if (!navigator.geolocation) {
                mostrarToast('Geolocalización no soportada', 'error');
                return;
            }

            mostrarToast('Obteniendo ubicación...', 'info');
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    var latlng = L.latLng(position.coords.latitude, position.coords.longitude);
                    
                    // Establecer como punto de origen
                    setPunto('origen', latlng, 'Mi Ubicación Actual');
                    
                    // También iniciar seguimiento GPS si no está activo
                    if (!gpsTracking) {
                        startGpsTracking();
                    }
                    
                    mostrarToast('Ubicación establecida como origen', 'success');
                },
                function(error) {
                    var message = 'Error al obtener la ubicación: ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message += 'Permiso denegado';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message += 'Posición no disponible';
                            break;
                        case error.TIMEOUT:
                            message += 'Tiempo de espera agotado';
                            break;
                        default:
                            message += 'Error desconocido';
                    }
                    mostrarToast(message, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // ============================================
        // 4. CORRECCIÓN: INFORMACIÓN GPS SIMPLIFICADA
        // ============================================
        
        // Actualizar panel de información GPS - SOLO VELOCIDAD Y PRECISIÓN
        function updateGpsInfo(position) {
            var infoPanel = document.getElementById('gps-info');
            if (!infoPanel) {
                infoPanel = document.createElement('div');
                infoPanel.id = 'gps-info';
                infoPanel.style.cssText = `
                    position: absolute; bottom: 80px; left: 15px;
                    background: rgba(255, 255, 255, 0.95); padding: 15px;
                    border-radius: var(--border-radius); box-shadow: var(--shadow-heavy);
                    z-index: 1000; font-size: 0.9rem; max-width: 280px;
                    backdrop-filter: blur(5px); display: flex; flex-direction: column; gap: 12px;
                `;
                document.getElementById('map-wrapper').appendChild(infoPanel);
            }
            
            // SOLO mostrar velocidad y precisión según requerimiento
            var speed = position.coords.speed ? 
                (position.coords.speed * 3.6).toFixed(1) + ' km/h' : 'N/A';
            var accuracy = Math.round(position.coords.accuracy) + ' m';
            
            infoPanel.innerHTML = `
                <div style="margin-bottom: 5px;">
                    <strong style="color: #2196F3; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-satellite"></i> GPS ACTIVO
                    </strong>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <small style="color: var(--prov-gray-medium);">Velocidad</small>
                        <div style="font-weight: 600; color: var(--prov-green-dark);">${speed}</div>
                    </div>
                    <div>
                        <small style="color: var(--prov-gray-medium);">Precisión</small>
                        <div style="font-weight: 600; color: #2196F3;">${accuracy}</div>
                    </div>
                </div>
                <div style="margin-top: 10px; text-align: center;">
                    <button onclick="stopGpsTracking()" style="
                        background: #f44336; color: white; border: none;
                        padding: 8px 16px; border-radius: 6px; font-size: 0.9rem;
                        cursor: pointer; width: 100%; display: flex; align-items: center;
                        justify-content: center; gap: 8px; font-weight: 500;
                    ">
                        <i class="fas fa-stop"></i> Detener Seguimiento
                    </button>
                </div>
            `;
            
            infoPanel.style.display = 'flex';
        }

        // ============================================
        // 5. CORRECCIÓN: FONDO AZUL AL ACTIVAR GPS
        // ============================================
        
        // Actualizar posición GPS - CORREGIDO PARA EVITAR FONDO AZUL
        function updateGpsPosition(position) {
            var latlng = L.latLng(position.coords.latitude, position.coords.longitude);
            var accuracy = position.coords.accuracy;
            
            // Crear o actualizar marcador
            if (!gpsMarker) {
                gpsMarker = L.marker(latlng, {
                    icon: L.divIcon({
                        className: 'gps-marker',
                        html: `
                            <div style="position: relative;">
                                <div style="
                                    width: 24px; height: 24px; background: #2196F3;
                                    border-radius: 50%; border: 3px solid white;
                                    box-shadow: 0 0 12px rgba(33, 150, 243, 0.8);
                                "></div>
                                <div style="
                                    position: absolute; top: 50%; left: 50%;
                                    width: 8px; height: 8px; background: white;
                                    border-radius: 50%; transform: translate(-50%, -50%);
                                "></div>
                            </div>
                        `,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    }),
                    zIndexOffset: 2000  // Aumentado para estar sobre paneles
                }).addTo(map);
            } else {
                gpsMarker.setLatLng(latlng);
            }
            
            // Círculo de precisión - COLOR MODIFICADO PARA NO CAMBIAR FONDO
            if (!gpsAccuracyCircle) {
                gpsAccuracyCircle = L.circle(latlng, {
                    radius: accuracy,
                    weight: 1,
                    color: '#757575',  // Cambiado a gris en lugar de azul
                    fillColor: '#757575',  // Cambiado a gris
                    fillOpacity: 0.05  // Reducido para ser menos intrusivo
                }).addTo(map);
            } else {
                gpsAccuracyCircle.setLatLng(latlng);
                gpsAccuracyCircle.setRadius(accuracy);
            }
            
            // Línea de trayectoria
            gpsTrackPoints.push([latlng.lat, latlng.lng]);
            updateGpsTrack();
            
            // Actualizar panel de información
            updateGpsInfo(position);
            
            // Seguimiento automático
            if (gpsTracking && !gpsCentered) {
                map.panTo(latlng);
                gpsCentered = true;
            }
        }

        // ============================================
        // 6. FUNCIONES AUXILIARES
        // ============================================
        
        function getNombre(feature) {
            if (!feature) return "Sin nombre";
            if (typeof feature === 'object' && feature.feature) {
                feature = feature.feature;
            }
            return feature.properties?.Nombre || 
                   feature.properties?.name || 
                   feature.properties?.NOMBRE || 
                   feature.properties?.Hacienda || 
                   "Ubicación sin nombre";
        }

        function rotateMap(degrees) {
            mapRotation = degrees % 360;
            
            var mapContainer = document.getElementById('map');
            mapContainer.style.transform = `rotate(${mapRotation}deg)`;
            
            document.querySelectorAll('.leaflet-control-container .leaflet-control').forEach(control => {
                if (!control.classList.contains('leaflet-control-compass')) {
                    control.style.transform = `rotate(${-mapRotation}deg)`;
                }
            });
            
            updateCompass();
        }

        function resetNorth() {
            rotateMap(0);
            
            var btn = document.getElementById('btn-north');
            btn.style.transform = 'rotate(360deg)';
            setTimeout(() => {
                btn.style.transform = '';
            }, 500);
            
            mostrarToast('Mapa orientado al norte', 'info');
        }

        function updateCompass() {
            var compassIcon = document.querySelector('#btn-north i');
            if (compassIcon) {
                compassIcon.style.transform = `rotate(${-mapRotation}deg)`;
            }
        }

        function toggleDeviceOrientation() {
            var btn = document.getElementById('btn-orientation');
            
            if (!deviceOrientationEnabled) {
                if (window.DeviceOrientationEvent) {
                    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                        DeviceOrientationEvent.requestPermission()
                            .then(permissionState => {
                                if (permissionState === 'granted') {
                                    enableDeviceOrientation();
                                    btn.classList.add('active');
                                    mostrarToast('Orientación por GPS activada', 'success');
                                }
                            })
                            .catch(err => {
                                mostrarToast('Permiso de orientación denegado', 'error');
                            });
                    } else {
                        enableDeviceOrientation();
                        btn.classList.add('active');
                        mostrarToast('Orientación por GPS activada', 'success');
                    }
                } else {
                    mostrarToast('Orientación por dispositivo no soportada', 'warning');
                }
            } else {
                disableDeviceOrientation();
                btn.classList.remove('active');
                mostrarToast('Orientación por GPS desactivada', 'info');
            }
        }

        function enableDeviceOrientation() {
            window.addEventListener('deviceorientation', handleDeviceOrientation);
            deviceOrientationEnabled = true;
        }

        function disableDeviceOrientation() {
            window.removeEventListener('deviceorientation', handleDeviceOrientation);
            deviceOrientationEnabled = false;
        }

        function handleDeviceOrientation(event) {
            if (event.alpha !== null && gpsMarker) {
                var heading = event.alpha;
                
                if (Math.abs(heading - previousHeading) > 2) {
                    rotateMap(heading);
                    previousHeading = heading;
                }
            }
        }

        // ============================================
        // 7. SISTEMA DE CAPAS
        // ============================================
        
        // Inicializar capas
        function initLayers() {
            // Configurar eventos de switches
            document.getElementById('toggle-haciendas').addEventListener('change', function(e) {
                toggleHaciendasLayer(e.target.checked);
            });
            
            document.getElementById('toggle-satelite').addEventListener('change', function(e) {
                toggleSatelliteLayer(e.target.checked);
            });
        }

        // Toggle capa de haciendas
        function toggleHaciendasLayer(mostrar) {
            if (haciendasLayer) {
                if (mostrar) {
                    map.addLayer(haciendasLayer);
                    mostrarToast('Capa de haciendas activada', 'success');
                } else {
                    map.removeLayer(haciendasLayer);
                    mostrarToast('Capa de haciendas oculta', 'info');
                }
            }
        }

        function toggleSatellite() {
            var btn = document.getElementById('btn-satellite');
            var checkbox = document.getElementById('toggle-satelite');
            
            if (map.hasLayer(satelite)) {
                map.removeLayer(satelite);
                btn.classList.remove('active');
                checkbox.checked = false;
                mostrarToast('Vista satélite desactivada', 'info');
            } else {
                satelite.addTo(map);
                btn.classList.add('active');
                checkbox.checked = true;
                mostrarToast('Vista satélite activada', 'success');
            }
        }

        function toggleSatelliteLayer(mostrar) {
            var btn = document.getElementById('btn-satellite');
            
            if (mostrar) {
                satelite.addTo(map);
                btn.classList.add('active');
                mostrarToast('Vista satélite activada', 'success');
            } else {
                map.removeLayer(satelite);
                btn.classList.remove('active');
                mostrarToast('Vista satélite desactivada', 'info');
            }
        }

        function toggleLayerControls() {
            var controls = document.getElementById('layer-controls');
            var btn = document.getElementById('btn-layers');
            
            if (controls.style.display === 'flex') {
                controls.style.display = 'none';
                btn.classList.remove('active');
            } else {
                controls.style.display = 'flex';
                btn.classList.add('active');
            }
        }

        // ============================================
        // 8. GPS EN TIEMPO REAL
        // ============================================
        
        function toggleGpsTracking() {
            if (!gpsTracking) {
                startGpsTracking();
            } else {
                stopGpsTracking();
            }
        }

        function startGpsTracking() {
            if (!navigator.geolocation) {
                mostrarToast('Geolocalización no soportada', 'error');
                return;
            }
            
            mostrarToast('Iniciando seguimiento GPS...', 'info');
            updateGpsStatus('Obteniendo ubicación...', '#2196F3');
            
            var options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0,
                distanceFilter: 5
            };
            
            // Obtener posición inicial
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    updateGpsPosition(position);
                    
                    // Iniciar seguimiento continuo
                    gpsWatchId = navigator.geolocation.watchPosition(
                        updateGpsPosition,
                        handleGpsError,
                        options
                    );
                    
                    gpsTracking = true;
                    updateGpsStatus('GPS activo', '#4CAF50');
                    mostrarToast('Seguimiento GPS activado', 'success');
                    
                    // Actualizar botón
                    document.getElementById('btn-gps-track').classList.add('active');
                    
                    // Centrar en posición inicial
                    map.setView([position.coords.latitude, position.coords.longitude], 16);
                    
                    // Iniciar línea de trayectoria
                    gpsTrackPoints = [[position.coords.latitude, position.coords.longitude]];
                    updateGpsTrack();
                },
                handleGpsError,
                options
            );
        }

        function updateGpsTrack() {
            if (gpsTrackPoints.length < 2) return;
            
            if (!gpsTrackLine) {
                gpsTrackLine = L.polyline(gpsTrackPoints, {
                    color: '#2196F3',
                    weight: 4,
                    opacity: 0.7,
                    smoothFactor: 1,
                    className: 'gps-track'
                }).addTo(map);
            } else {
                gpsTrackLine.setLatLngs(gpsTrackPoints);
            }
        }

        function stopGpsTracking() {
            if (gpsWatchId !== null) {
                navigator.geolocation.clearWatch(gpsWatchId);
                gpsWatchId = null;
            }
            
            gpsTracking = false;
            gpsCentered = false;
            
            if (gpsMarker) {
                map.removeLayer(gpsMarker);
                gpsMarker = null;
            }
            
            if (gpsAccuracyCircle) {
                map.removeLayer(gpsAccuracyCircle);
                gpsAccuracyCircle = null;
            }
            
            if (gpsTrackLine) {
                map.removeLayer(gpsTrackLine);
                gpsTrackLine = null;
            }
            
            var infoPanel = document.getElementById('gps-info');
            if (infoPanel) {
                infoPanel.style.display = 'none';
            }
            
            updateGpsStatus('GPS desconectado', '#9E9E9E');
            document.getElementById('btn-gps-track').classList.remove('active');
            mostrarToast('Seguimiento GPS detenido', 'info');
        }

        function handleGpsError(error) {
            var message = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Permiso de ubicación denegado';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Ubicación no disponible';
                    break;
                case error.TIMEOUT:
                    message = 'Tiempo de espera agotado';
                    break;
                default:
                    message = 'Error desconocido';
            }
            
            updateGpsStatus(message, '#F44336');
            mostrarToast('Error GPS: ' + message, 'error');
            stopGpsTracking();
        }

        function updateGpsStatus(text, color) {
            var statusEl = document.getElementById('gps-status');
            var textEl = document.getElementById('gps-status-text');
            
            if (statusEl && textEl) {
                textEl.textContent = text;
                statusEl.style.display = 'flex';
                statusEl.style.background = color;
            }
        }

        // ============================================
        // 9. CARGA DE DATOS GEOESPACIALES
        // ============================================
        
        function cargarHaciendas() {
            fetch('haciendas.geojson')
                .then(res => {
                    if (!res.ok) throw new Error("Error cargando datos");
                    return res.json();
                })
                .then(data => {
                    dbHaciendas = data.features;
                    processHaciendasData(dbHaciendas);
                    mostrarToast('Datos geográficos cargados', 'success');
                })
                .catch(err => {
                    console.warn("Usando datos de ejemplo:", err);
                    crearDatosEjemplo();
                    mostrarToast('Cargando datos de ejemplo', 'warning');
                });
        }

        function crearDatosEjemplo() {
            dbHaciendas = [
                {
                    "type": "Feature",
                    "properties": {
                        "Nombre": "Hacienda Providencia",
                        "Area": "120"
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [-76.315, 3.615], [-76.305, 3.615], 
                            [-76.305, 3.625], [-76.315, 3.625], 
                            [-76.315, 3.615]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "Nombre": "Hacienda San José",
                        "Area": "85"
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [-76.285, 3.595], [-76.275, 3.595], 
                            [-76.275, 3.605], [-76.285, 3.605], 
                            [-76.285, 3.595]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "Nombre": "Planta de Procesamiento",
                        "Area": "45"
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [-76.295, 3.635], [-76.285, 3.635], 
                            [-76.285, 3.645], [-76.295, 3.645], 
                            [-76.295, 3.635]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "Nombre": "Centro de Acopio Norte",
                        "Area": "30"
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [-76.265, 3.645], [-76.255, 3.645], 
                            [-76.255, 3.655], [-76.265, 3.655], 
                            [-76.265, 3.645]
                        ]]
                    }
                }
            ];
            processHaciendasData(dbHaciendas);
        }

        function processHaciendasData(data) {
            haciendasLayer = L.geoJSON(data, {
                style: function(feature) {
                    return {
                        fillColor: '#81c784',
                        weight: 2,
                        opacity: 0.8,
                        color: '#4caf50',
                        fillOpacity: 0.3,
                        className: 'hacienda-polygon'
                    };
                },
                onEachFeature: function(feature, layer) {
                    var nombre = getNombre(feature);
                    var area = feature.properties.Area;
                    
                    layer.bindTooltip(`
                        <div style="font-weight: 600; color: #1b5e20; margin-bottom: 6px;">
                            <i class="fas fa-tractor"></i> ${nombre}
                        </div>
                        ${area ? `<div style="font-size: 0.9em; color: var(--prov-gray-medium);">Área: ${area} ha</div>` : ''}
                        <div style="font-size: 0.8em; color: #666; margin-top: 6px;">
                            Haga clic para seleccionar
                        </div>
                    `, {
                        direction: 'top',
                        sticky: true,
                        className: 'hacienda-tooltip'
                    });
                    
                    layer.on('click', function() {
                        var centro = layer.getBounds().getCenter();
                        
                        if (highlightLayer) {
                            map.removeLayer(highlightLayer);
                        }
                        
                        highlightLayer = L.geoJSON(feature, {
                            style: {
                                fillColor: '#ff5722',
                                weight: 4,
                                opacity: 0.9,
                                color: '#ff5722',
                                fillOpacity: 0.4
                            }
                        }).addTo(map);
                        
                        var esDestino = confirm("¿Establecer como destino? (Cancelar para origen)");
                        var tipo = esDestino ? 'dest' : 'origen';
                        setPunto(tipo, centro, nombre);
                    });
                    
                    layer.on('mouseover', function() {
                        layer.setStyle({
                            fillOpacity: 0.6,
                            weight: 3,
                            color: '#2e7d32'
                        });
                    });
                    
                    layer.on('mouseout', function() {
                        layer.setStyle({
                            fillOpacity: 0.3,
                            weight: 2,
                            color: '#4caf50'
                        });
                    });
                }
            }).addTo(map);
            
            if (dbHaciendas.length > 0) {
                var bounds = haciendasLayer.getBounds();
                map.fitBounds(bounds, { padding: [50, 50], maxZoom: 14 });
            }
        }

        // ============================================
        // 10. GESTIÓN DE PUNTOS EN EL MAPA
        // ============================================
        
        function setPunto(tipo, latlng, nombre) {
            // Eliminar marcador anterior
            if (markers[tipo]) {
                map.removeLayer(markers[tipo]);
            }
            
            // Crear nuevo marcador
            markers[tipo] = L.marker(latlng, {
                icon: createCustomIcon(tipo),
                zIndexOffset: 1000
            })
            .addTo(map)
            .bindPopup(`
                <div style="text-align: center; padding: 10px; min-width: 180px;">
                    <strong style="color: ${COLORS[tipo]}; display: block; margin-bottom: 8px;">
                        <i class="fas fa-${tipo === 'origen' ? 'play' : tipo === 'inter' ? 'pause' : 'flag'}"></i>
                        ${tipo.toUpperCase()}
                    </strong>
                    <div style="font-size: 0.95em; margin-bottom: 6px;">${nombre}</div>
                    <div style="font-size: 0.85em; color: var(--prov-gray-medium);">
                        ${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}
                    </div>
                </div>
            `)
            .openPopup();
            
            // Guardar punto
            puntos[tipo] = latlng;
            document.getElementById('input-' + tipo).value = nombre;
            
            // Actualizar estado
            actualizarEstadoApp();
            
            // Centrar mapa
            map.setView(latlng, 14);
            
            // Salir del modo manual
            if (modoManual === tipo) {
                document.getElementById('map').style.cursor = '';
                modoManual = null;
                mostrarToast('Ubicación seleccionada en el mapa', 'success');
            }
            
            // Cerrar resultados de búsqueda
            var lista = document.getElementById('list-' + tipo);
            if (lista) lista.style.display = 'none';
            
            // Recalcular ruta si ya hay una
            if (currentRoute && (tipo === 'origen' || tipo === 'dest' || tipo === 'inter')) {
                setTimeout(calcularRuta, 500);
            }
        }

        function activarManual(tipo) {
            modoManual = tipo;
            document.getElementById('map').style.cursor = 'crosshair';
            
            var texto = tipo === 'origen' ? 'origen' : 
                       tipo === 'dest' ? 'destino' : 'parada intermedia';
            mostrarToast(`Haga clic en el mapa para seleccionar ${texto}`, 'info');
            
            // En móvil, cerrar sidebar para ver mejor el mapa
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        // Evento de clic en el mapa
        map.on('click', function(e) {
            if (modoManual) {
                var tipoNombre = modoManual === 'origen' ? 'Origen' : 
                               modoManual === 'inter' ? 'Parada Intermedia' : 'Destino';
                setPunto(modoManual, e.latlng, `${tipoNombre} Manual`);
            }
        });

        // ============================================
        // 11. CÁLCULO Y VISUALIZACIÓN DE RUTAS
        // ============================================
        
        function calcularRuta() {
            // Validaciones
            if (!puntos.origen) {
                mostrarToast('Seleccione un punto de origen', 'warning');
                document.getElementById('input-origen').focus();
                return;
            }
            
            if (!puntos.dest) {
                mostrarToast('Seleccione un punto de destino', 'warning');
                document.getElementById('input-dest').focus();
                return;
            }
            
            // Limpiar ruta anterior
            if (controlRuta) {
                map.removeControl(controlRuta);
                controlRuta = null;
            }
            
            if (highlightLayer) {
                map.removeLayer(highlightLayer);
                highlightLayer = null;
            }
            
            // Mostrar loading
            var routeBtn = document.getElementById('btn-calcular');
            var routeLoading = document.getElementById('route-loading');
            var routeIcon = document.getElementById('route-icon');
            var routeText = document.getElementById('route-text');
            
            routeLoading.style.display = 'inline-block';
            routeIcon.style.display = 'none';
            routeText.textContent = 'CALCULANDO...';
            routeBtn.disabled = true;
            
            // Preparar waypoints
            var waypoints = [puntos.origen];
            if (puntos.inter) waypoints.push(puntos.inter);
            waypoints.push(puntos.dest);
            
            // Ocultar panel de instrucciones
            toggleInstrucciones(false);
            
            // En móvil, cerrar sidebar
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
            
            // Calcular ruta
            controlRuta = L.Routing.control({
                waypoints: waypoints,
                language: 'es',
                router: L.Routing.osrmv1({
                    serviceUrl: 'https://router.project-osrm.org/route/v1',
                    profile: 'driving'
                }),
                formatter: new L.Routing.Formatter({ language: 'es' }),
                showAlternatives: true,
                lineOptions: {
                    styles: [{color: COLORS.route, opacity: 0.9, weight: 8}],
                    addWaypoints: false,
                    extendToWaypoints: true,
                    missingRouteTolerance: 10
                },
                altLineOptions: {
                    styles: [
                        {color: COLORS.altRoute, opacity: 0.7, weight: 6, dashArray: '15, 10'},
                        {color: '#f39c12', opacity: 0.7, weight: 6, dashArray: '20, 15'},
                        {color: '#2ecc71', opacity: 0.7, weight: 6, dashArray: '25, 20'}
                    ]
                },
                createMarker: () => null,
                routeWhileDragging: false,
                show: false
            }).addTo(map);
            
            // Eventos de ruta
            controlRuta.on('routesfound', function(e) {
                rutasEncontradas = e.routes;
                rutaIndex = 0;
                currentRoute = rutasEncontradas[0];
                
                // Mostrar datos de la ruta
                mostrarDatosRuta(currentRoute);
                
                // Ajustar vista
                if (rutasEncontradas.length > 0) {
                    var bounds = L.latLngBounds(rutasEncontradas[0].coordinates);
                    map.fitBounds(bounds, { 
                        padding: [100, 100],
                        maxZoom: 15
                    });
                }
                
                // Actualizar UI
                routeLoading.style.display = 'none';
                routeIcon.style.display = 'inline-block';
                routeText.textContent = 'RUTA CALCULADA';
                routeBtn.disabled = false;
                
                // Mostrar botones adicionales
                var btnAlt = document.getElementById('btn-alt');
                var btnInstr = document.getElementById('btn-instr');
                var btnDownload = document.getElementById('btn-download');
                
                btnInstr.style.display = 'block';
                btnDownload.style.display = 'flex';
                
                if (rutasEncontradas.length > 1) {
                    btnAlt.style.display = 'block';
                    btnAlt.innerHTML = `<i class="fas fa-exchange-alt"></i> Cambiar Ruta (${rutasEncontradas.length} opciones)`;
                }
                
                mostrarToast(`Ruta calculada: ${rutasEncontradas.length} opciones`, 'success');
                
                // Mostrar instrucciones
                setTimeout(() => {
                    if (window.innerWidth > 768) {
                        toggleInstrucciones(true);
                    } else {
                        document.getElementById('mobile-instructions').style.display = 'block';
                    }
                }, 500);
            });
            
            controlRuta.on('routingerror', function(e) {
                routeLoading.style.display = 'none';
                routeIcon.style.display = 'inline-block';
                routeText.textContent = 'CALCULAR RUTA';
                routeBtn.disabled = false;
                
                mostrarToast('No se pudo calcular la ruta. Verifique las ubicaciones', 'error');
                document.getElementById('route-info').style.display = 'none';
            });
        }

        function cambiarRutaAlternativa() {
            if (!rutasEncontradas || rutasEncontradas.length < 2) return;
            
            rutaIndex = (rutaIndex + 1) % rutasEncontradas.length;
            currentRoute = rutasEncontradas[rutaIndex];
            
            // Actualizar visualización
            mostrarDatosRuta(currentRoute);
            
            // Ajustar vista
            var bounds = L.latLngBounds(currentRoute.coordinates);
            map.fitBounds(bounds, { 
                padding: [100, 100],
                maxZoom: 15
            });
            
            // Actualizar botón
            var btnAlt = document.getElementById('btn-alt');
            btnAlt.innerHTML = `<i class="fas fa-route"></i> Ruta ${rutaIndex + 1} de ${rutasEncontradas.length}`;
            
            mostrarToast(`Cambiada a ruta alternativa ${rutaIndex + 1}`, 'info');
        }

        // ============================================
        // 12. PANEL DE INSTRUCCIONES Y NAVEGACIÓN POR VOZ
        // ============================================
        
        function mostrarDatosRuta(ruta) {
            var km = (ruta.summary.totalDistance / 1000).toFixed(1);
            var min = Math.round(ruta.summary.totalTime / 60);
            
            // Actualizar información en sidebar
            var routeInfo = document.getElementById('route-info');
            var routeDetails = document.getElementById('route-details');
            
            routeInfo.style.display = 'block';
            routeDetails.innerHTML = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 2.5rem; font-weight: bold; color: ${COLORS.route}; margin-bottom: 10px;">
                        ${km} <small style="font-size: 1.2rem;">km</small>
                    </div>
                    <div style="font-size: 1.4rem; color: var(--prov-gray-medium); margin-bottom: 20px;">
                        <i class="fas fa-clock"></i> ${min} minutos estimados
                    </div>
                    <div style="background: var(--prov-green-lighter); padding: 15px; border-radius: var(--border-radius);">
                        <div style="margin-bottom: 12px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-play" style="color: ${COLORS.origin};"></i>
                            <div style="flex: 1;">
                                <div style="font-size: 0.9rem; color: var(--prov-gray-medium);">Origen</div>
                                <div style="font-weight: 500;">${document.getElementById('input-origen').value}</div>
                            </div>
                        </div>
                        ${puntos.inter ? `
                        <div style="margin-bottom: 12px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-pause" style="color: ${COLORS.inter};"></i>
                            <div style="flex: 1;">
                                <div style="font-size: 0.9rem; color: var(--prov-gray-medium);">Parada</div>
                                <div style="font-weight: 500;">${document.getElementById('input-inter').value}</div>
                            </div>
                        </div>` : ''}
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-flag" style="color: ${COLORS.dest};"></i>
                            <div style="flex: 1;">
                                <div style="font-size: 0.9rem; color: var(--prov-gray-medium);">Destino</div>
                                <div style="font-weight: 500;">${document.getElementById('input-dest').value}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Actualizar panel de instrucciones
            updateInstructionsPanel(ruta);
        }

        function updateInstructionsPanel(ruta) {
            var summaryPanel = document.getElementById('route-summary');
            var contentPanel = document.getElementById('directions-content');
            var mobileContentPanel = document.getElementById('mobile-directions-content');
            
            // Resumen
            summaryPanel.innerHTML = `
                <h3><i class="fas fa-info-circle"></i> Resumen de Ruta</h3>
                <div class="route-stats">
                    <div class="stat-item">
                        <span class="stat-value">${(ruta.summary.totalDistance / 1000).toFixed(1)}</span>
                        <span class="stat-label">Distancia</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">${Math.round(ruta.summary.totalTime / 60)}</span>
                        <span class="stat-label">Tiempo</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value">${ruta.instructions.length}</span>
                        <span class="stat-label">Pasos</span>
                    </div>
                </div>
            `;
            
            // Instrucciones
            contentPanel.innerHTML = '';
            if (mobileContentPanel) mobileContentPanel.innerHTML = '';
            
            ruta.instructions.forEach((step, index) => {
                var iconClass = getStepIcon(step.type, step.modifier);
                var dist = formatStepDistance(step.distance);
                
                // Limpiar texto
                var cleanText = step.text
                    .replace(/Continue on/g, "Continúe por")
                    .replace(/Turn left/g, "Gire a la izquierda")
                    .replace(/Turn right/g, "Gire a la derecha")
                    .replace(/sharp left/g, "gire bruscamente a la izquierda")
                    .replace(/sharp right/g, "gire bruscamente a la derecha")
                    .replace(/slight left/g, "gire ligeramente a la izquierda")
                    .replace(/slight right/g, "gire ligeramente a la derecha")
                    .replace(/Destination reached/g, "Ha llegado a su destino");
                
                var stepDiv = createInstructionStep(index + 1, cleanText, dist, iconClass);
                contentPanel.appendChild(stepDiv);
                
                // Para móvil
                if (mobileContentPanel) {
                    var mobileDiv = stepDiv.cloneNode(true);
                    mobileContentPanel.appendChild(mobileDiv);
                }
            });
            
            // Progreso
            actualizarProgresoRuta(ruta);
        }

        function getStepIcon(type, mod) {
            switch(type) {
                case 'Head': return 'fas fa-road';
                case 'Continue': return 'fas fa-long-arrow-alt-right';
                case 'TurnLeft': return 'fas fa-arrow-left';
                case 'TurnRight': return 'fas fa-arrow-right';
                case 'SharpLeft': return 'fas fa-arrow-circle-left';
                case 'SharpRight': return 'fas fa-arrow-circle-right';
                case 'SlightLeft': return 'fas fa-arrow-left rotate-45';
                case 'SlightRight': return 'fas fa-arrow-right rotate-45';
                case 'Roundabout': return 'fas fa-sync';
                case 'DestinationReached': return 'fas fa-flag-checkered';
                case 'WaypointReached': return 'fas fa-map-pin';
                default:
                    if (mod && mod.includes('Left')) return 'fas fa-arrow-left';
                    if (mod && mod.includes('Right')) return 'fas fa-arrow-right';
                    return 'fas fa-arrow-up';
            }
        }

        function formatStepDistance(meters) {
            if (meters === 0) return "";
            if (meters >= 1000) return (meters / 1000).toFixed(1) + ' km';
            return Math.round(meters) + ' m';
        }

        function createInstructionStep(num, text, distance, iconClass) {
            var div = document.createElement('div');
            div.className = 'instruction-step';
            div.innerHTML = `
                <div class="step-icon">
                    <i class="${iconClass}"></i>
                </div>
                <div class="step-content">
                    <div class="step-text">${text}</div>
                </div>
                <div class="step-dist">${distance}</div>
            `;
            return div;
        }

        function actualizarProgresoRuta(ruta) {
            var totalDist = ruta.summary.totalDistance;
            
            // Limpiar intervalo anterior
            if (window.progressInterval) {
                clearInterval(window.progressInterval);
            }
            
            // Simular progreso
            var acumulado = 0;
            window.progressInterval = setInterval(() => {
                acumulado += totalDist / 100;
                if (acumulado > totalDist) {
                    acumulado = totalDist;
                    clearInterval(window.progressInterval);
                }
                
                var percent = Math.min(100, (acumulado / totalDist * 100));
                document.getElementById('progress-fill').style.width = percent + '%';
                document.getElementById('progress-percent').textContent = Math.round(percent) + '%';
            }, 50);
        }

        function toggleInstrucciones(mostrar) {
            var panel = document.getElementById('floating-directions');
            var btnInstr = document.getElementById('btn-instr');
            var mobileInstructions = document.getElementById('mobile-instructions');
            
            if (window.innerWidth <= 768) {
                // Móvil
                if (mostrar === true) {
                    mobileInstructions.style.display = 'block';
                    btnInstr.innerHTML = '<i class="fas fa-times"></i> Cerrar Instrucciones';
                    btnInstr.onclick = function() { toggleInstrucciones(false); };
                    
                    // Abrir sidebar si no está abierto
                    if (!document.getElementById('sidebar').classList.contains('active')) {
                        toggleSidebar();
                    }
                } else if (mostrar === false) {
                    mobileInstructions.style.display = 'none';
                    btnInstr.innerHTML = '<i class="fas fa-directions"></i> Ver Instrucciones';
                    btnInstr.onclick = function() { toggleInstrucciones(true); };
                }
            } else {
                // Escritorio
                if (mostrar === true) {
                    panel.style.display = 'flex';
                    btnInstr.innerHTML = '<i class="fas fa-times"></i> Cerrar Instrucciones';
                    btnInstr.onclick = function() { toggleInstrucciones(false); };
                } else if (mostrar === false) {
                    panel.style.display = 'none';
                    btnInstr.innerHTML = '<i class="fas fa-directions"></i> Ver Instrucciones';
                    btnInstr.onclick = function() { toggleInstrucciones(true); };
                }
            }
        }

        // ============================================
        // 13. NAVEGACIÓN POR VOZ
        // ============================================
        
        var speechEnabled = true;
        var spanishVoice = null;

        function initSpeechSynthesis() {
            if (!speechSynthesis) {
                console.warn('Web Speech API no soportada');
                speechEnabled = false;
                return;
            }
            
            // Cargar voces
            speechSynthesis.onvoiceschanged = function() {
                var voices = speechSynthesis.getVoices();
                spanishVoice = voices.find(voice => 
                    voice.lang.startsWith('es-') || 
                    voice.name.toLowerCase().includes('spanish')
                );
                
                if (!spanishVoice && voices.length > 0) {
                    spanishVoice = voices[0];
                }
            };
            
            // Forzar carga
            setTimeout(() => {
                if (!spanishVoice) {
                    var voices = speechSynthesis.getVoices();
                    spanishVoice = voices.find(voice => voice.lang.startsWith('es'));
                }
            }, 1000);
        }

        function speakInstructions() {
            if (!speechEnabled || !currentRoute) {
                mostrarToast('No hay instrucciones para leer', 'warning');
                return;
            }
            
            stopSpeaking();
            
            var instructionText = `Iniciando navegación. Ruta de ${(currentRoute.summary.totalDistance / 1000).toFixed(1)} kilómetros. `;
            
            currentRoute.instructions.forEach((step, index) => {
                var cleanText = step.text
                    .replace(/Continue on/g, "Continúe por")
                    .replace(/Turn left/g, "Gire a la izquierda")
                    .replace(/Turn right/g, "Gire a la derecha")
                    .replace(/Destination reached/g, "Ha llegado a su destino");
                
                var distancia = step.distance > 1000 ? 
                    `${(step.distance/1000).toFixed(1)} kilómetros` : 
                    `${Math.round(step.distance)} metros`;
                
                instructionText += `Paso ${index + 1}: ${cleanText} en ${distancia}. `;
            });
            
            instructionText += `Fin de las instrucciones.`;
            
            var utterance = new SpeechSynthesisUtterance(instructionText);
            utterance.lang = 'es-ES';
            utterance.rate = 1.0;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            if (spanishVoice) {
                utterance.voice = spanishVoice;
            }
            
            utterance.onstart = function() {
                mostrarToast('Reproduciendo instrucciones', 'info');
            };
            
            utterance.onend = function() {
                mostrarToast('Instrucciones completadas', 'success');
                currentSpeech = null;
            };
            
            utterance.onerror = function(event) {
                console.error('Error en voz:', event);
                mostrarToast('Error al reproducir voz', 'error');
                currentSpeech = null;
            };
            
            currentSpeech = utterance;
            speechSynthesis.speak(utterance);
        }

        function stopSpeaking() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                mostrarToast('Voz detenida', 'info');
            }
            currentSpeech = null;
        }

        // ============================================
        // 14. FUNCIONALIDADES ADICIONALES
        // ============================================
        
        function toggleParada(mostrar) {
            var stopSection = document.getElementById('stopover-section');
            var addBtn = document.getElementById('btn-add-stop');
            
            stopSection.style.display = mostrar ? 'block' : 'none';
            addBtn.style.display = mostrar ? 'none' : 'block';
            
            if (!mostrar) {
                puntos.inter = null;
                if(markers.inter) {
                    map.removeLayer(markers.inter);
                    markers.inter = null;
                }
                document.getElementById('input-inter').value = "";
                
                if (currentRoute) {
                    calcularRuta();
                }
            }
        }

        function descargarVia() {
            if (!currentRoute) {
                mostrarToast('No hay ruta calculada para descargar', 'warning');
                return;
            }
            
            var geoJson = {
                "type": "FeatureCollection",
                "features": [{
                    "type": "Feature",
                    "properties": {
                        "name": "Ruta Providencia",
                        "distance": currentRoute.summary.totalDistance,
                        "time": currentRoute.summary.totalTime,
                        "created": new Date().toISOString(),
                        "origen": document.getElementById('input-origen').value,
                        "destino": document.getElementById('input-dest').value
                    },
                    "geometry": {
                        "type": "LineString",
                        "coordinates": currentRoute.coordinates.map(coord => [coord.lng, coord.lat])
                    }
                }]
            };
            
            var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(geoJson, null, 2));
            var downloadAnchor = document.createElement('a');
            downloadAnchor.setAttribute("href", dataStr);
            downloadAnchor.setAttribute("download", "ruta_providencia_" + new Date().toISOString().slice(0,10) + ".geojson");
            document.body.appendChild(downloadAnchor);
            downloadAnchor.click();
            document.body.removeChild(downloadAnchor);
            
            mostrarToast('Ruta descargada como GeoJSON', 'success');
        }

        function eliminarVia() {
            if (controlRuta) {
                map.removeControl(controlRuta);
                controlRuta = null;
            }
            
            currentRoute = null;
            rutasEncontradas = [];
            
            // Actualizar UI
            document.getElementById('route-info').style.display = 'none';
            document.getElementById('btn-alt').style.display = 'none';
            document.getElementById('btn-instr').style.display = 'none';
            document.getElementById('btn-download').style.display = 'none';
            
            toggleInstrucciones(false);
            
            mostrarToast('Ruta eliminada del mapa', 'info');
        }

        function limpiarTodo() {
            if (Object.values(puntos).some(p => p !== null) && 
                !confirm('¿Está seguro de que desea borrar toda la información actual?')) {
                return;
            }
            
            // Resetear puntos
            puntos = { origen: null, inter: null, dest: null };
            
            // Eliminar marcadores
            Object.values(markers).forEach(marker => {
                if (marker) map.removeLayer(marker);
            });
            markers = { origen: null, inter: null, dest: null };
            
            // Detener GPS
            stopGpsTracking();
            
            // Detener voz
            stopSpeaking();
            
            // Resetear UI
            document.querySelectorAll('input[type="text"]').forEach(input => input.value = '');
            document.getElementById('route-info').style.display = 'none';
            document.getElementById('btn-alt').style.display = 'none';
            document.getElementById('btn-instr').style.display = 'none';
            document.getElementById('btn-download').style.display = 'none';
            document.getElementById('stopover-section').style.display = 'none';
            document.getElementById('btn-add-stop').style.display = 'block';
            document.getElementById('mobile-instructions').style.display = 'none';
            
            // Ocultar controles
            document.getElementById('layer-controls').style.display = 'none';
            document.getElementById('btn-layers').classList.remove('active');
            
            // Ocultar resultados de búsqueda
            document.querySelectorAll('.search-results').forEach(list => {
                list.style.display = 'none';
            });
            
            // Ocultar panel de instrucciones
            toggleInstrucciones(false);
            
            // Resetear variables
            rutasEncontradas = [];
            rutaIndex = 0;
            currentRoute = null;
            modoManual = null;
            
            // Eliminar ruta
            eliminarVia();
            
            // Actualizar estado
            actualizarEstadoApp();
            
            mostrarToast('Sistema reiniciado. Listo para nueva consulta.', 'success');
        }

        function actualizarEstadoApp() {
            var state = document.getElementById('app-state');
            var icon = state.querySelector('i');
            var text = state.querySelector('span');
            
            var puntosCompletados = Object.values(puntos).filter(p => p !== null).length;
            var totalPuntos = puntos.inter ? 3 : 2;
            
            if (puntosCompletados === totalPuntos && currentRoute) {
                icon.style.color = '#4CAF50';
                text.textContent = 'Ruta calculada y lista';
            } else if (puntosCompletados >= 2) {
                icon.style.color = '#FFC107';
                text.textContent = 'Listo para calcular ruta';
            } else {
                icon.style.color = '#F44336';
                text.textContent = 'Seleccione ubicaciones';
            }
        }

        function toggleSidebar() {
            var sb = document.getElementById('sidebar');
            var toggleBtn = document.getElementById('sidebar-toggle');
            var isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                sb.classList.toggle('active');
                document.body.style.overflow = sb.classList.contains('active') ? 'hidden' : '';
                
                // Ocultar resultados de búsqueda
                if (sb.classList.contains('active')) {
                    document.querySelectorAll('.search-results').forEach(list => {
                        list.style.display = 'none';
                    });
                }
            } else {
                sb.classList.toggle('collapsed');
            }
            
            // Ajustar mapa
            setTimeout(() => {
                map.invalidateSize(true);
                map._onResize();
                
                if (isMobile && sb.classList.contains('active')) {
                    toggleBtn.style.display = 'none';
                } else if (isMobile) {
                    toggleBtn.style.display = 'flex';
                }
            }, 350);
        }

        function mostrarToast(mensaje, tipo = 'info') {
            var toast = document.getElementById('toast');
            var toastMsg = document.getElementById('toast-message');
            var icon = toast.querySelector('i');
            
            switch(tipo) {
                case 'success':
                    icon.className = 'fas fa-check-circle';
                    toast.style.background = 'linear-gradient(135deg, #2e7d32, #1b5e20)';
                    break;
                case 'warning':
                    icon.className = 'fas fa-exclamation-triangle';
                    toast.style.background = 'linear-gradient(135deg, #fbc02d, #f57c00)';
                    break;
                case 'error':
                    icon.className = 'fas fa-times-circle';
                    toast.style.background = 'linear-gradient(135deg, #d32f2f, #b71c1c)';
                    break;
                default:
                    icon.className = 'fas fa-info-circle';
                    toast.style.background = 'linear-gradient(135deg, #1976d2, #0d47a1)';
            }
            
            toastMsg.textContent = mensaje;
            toast.style.display = 'flex';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // ============================================
        // 15. INICIALIZACIÓN
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar datos
            cargarHaciendas();
            
            // Inicializar componentes
            initSearchEvents();
            initLayers();
            initSpeechSynthesis();
            
            // Configurar evento de clic en mapa
            map.on('click', function(e) {
                if (modoManual) {
                    var tipoNombre = modoManual === 'origen' ? 'Origen' : 
                                   modoManual === 'inter' ? 'Parada Intermedia' : 'Destino';
                    setPunto(modoManual, e.latlng, `${tipoNombre} Manual`);
                }
            });
            
            // Actualizar estado inicial
            actualizarEstadoApp();
            
            // Ajustar tamaño del mapa en resize
            window.addEventListener('resize', function() {
                setTimeout(() => {
                    map.invalidateSize(true);
                }, 250);
            });
            
            // Cerrar controles de capas al hacer clic fuera
            document.addEventListener('click', function(e) {
                var layerControls = document.getElementById('layer-controls');
                var btnLayers = document.getElementById('btn-layers');
                
                if (layerControls.style.display === 'flex' && 
                    !layerControls.contains(e.target) && 
                    !btnLayers.contains(e.target)) {
                    layerControls.style.display = 'none';
                    btnLayers.classList.remove('active');
                }
            });
            
            // Configurar arrastre del panel flotante
            setupDragAndDrop();
        });

        function setupDragAndDrop() {
            var dragItem = document.getElementById('floating-directions');
            var dragHandle = document.getElementById('drag-handle');
            var active = false;
            var currentX, currentY, initialX, initialY, xOffset = 0, yOffset = 0;

            dragHandle.addEventListener("touchstart", dragStart, false);
            dragHandle.addEventListener("touchend", dragEnd, false);
            dragHandle.addEventListener("touchmove", drag, false);
            dragHandle.addEventListener("mousedown", dragStart, false);
            document.addEventListener("mouseup", dragEnd, false);
            document.addEventListener("mousemove", drag, false);

            function dragStart(e) {
                if (e.target.id === 'close-float-btn') return;
                
                if (e.type === "touchstart") {
                    initialX = e.touches[0].clientX - xOffset;
                    initialY = e.touches[0].clientY - yOffset;
                } else {
                    initialX = e.clientX - xOffset;
                    initialY = e.clientY - yOffset;
                }
                
                if (e.target === dragHandle || dragHandle.contains(e.target)) {
                    active = true;
                }
            }

            function dragEnd() {
                initialX = currentX;
                initialY = currentY;
                active = false;
            }

            function drag(e) {
                if (active) {
                    e.preventDefault();
                    
                    if (e.type === "touchmove") {
                        currentX = e.touches[0].clientX - initialX;
                        currentY = e.touches[0].clientY - initialY;
                    } else {
                        currentX = e.clientX - initialX;
                        currentY = e.clientY - initialY;
                    }
                    
                    xOffset = currentX;
                    yOffset = currentY;
                    
                    dragItem.style.transform = "translate3d(" + currentX + "px, " + currentY + "px, 0)";
                }
            }
        }
    </script>
</body>
</html>
